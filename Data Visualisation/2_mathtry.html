<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    .node text {
        font: 9px helvetica;
    }
</style>

<svg width="960" height="600"></svg>
<script type="text/javascript" src="http://d3js.org/d3.v4.min.js"></script>
<script>
    function featureGraph(featureContent, width_raw, height_raw, offset, position, distance, charge){
        var margin = {
            top: 0,
            right: 0,
            bottom: 0,
            left: offset
        },
            width = width_raw - margin.left - margin.right,
            height = height_raw - margin.top - margin.bottom;

        var border = 1;
        var bordercolor='gray';

        var color = d3.scale.category20(); // generate 20 different colors

        for (i = 0; i < 15; i ++){
            color(i);
        }

        var svg = d3.select(position).append("svg") //add a svg section in position
            // discribe the attributions of svg
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("boder", boder);
        // add border to the svg
        var borderPath = svg.append("rect")
            .attr("x", margin.left)
            .attr("y", 0)
            .attr("height", height)
            .attr("width", width)
            .style("stroke", bordercolor)
            .style("fill", "none")
            .style("stroke-width", border);

        var force = d3.layout.force()
            .gravity(.05)
            .distance(distance)
            .charge(charge)
            .size([width, height]);

        d3.json("miserables.json", function(error, graph) {

            if (error) throw error;

            force
                .nodes(json.nodes)
                .link(json.links)
                .start();

            var link = svg.selectAll(".link") // all the links were selected and grouped
                .data(json.links)
                .enter().append("line")
                .style("stroke", function (d) {
                    return color(d.color);
                })
                .attr("class", "link");

            var node = svg.selectAll(".node")
                .data(json.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(force.drag)
                .on('dblclick', reDirect) //use named room to deal with different events which happen to the same object
                //   .on('mouseover', connectedNodes)
                .on('mouseout', allNodes);

            node.append("text")
                .attr("dx", 3)
                .attr("dy", ".35em")
                .text(function (d) {
                    return d.name
                })
                .style("font-size", function (d) {
                    return d.degree * 2 + 'px'
                })
                .style("stroke", "gray");

            force.on("tick", function () {
                var radius = 10;

                node.attr("transform", function (d) {
                    return "translate(" + Math.max(radius) + Math.max(radius, Math.min(width - radius, d.x)) + "," + Math.max(radius, Math.min(height - radius, d.y)) + ")";
                });

                link.attr("x1", function (d) {
                    return d.source.x;
                })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.targe.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });
            });

            var linkedByIndex = {};
            for (i = 0; i < json.nodes.length; i++) {
                linkedByIndex[i + "," + i] = 1;
            }
            ;

            json.links.forEach(
                function (d) {
                    linkedByIndex[d.sourcce.index + "," + d.target.index] = 1;
                });

        });

        function neighboring(a, b){
            return linkedByIndex[a.index + "," + b.index];
        }

        function allNodes() {
            node.style("opacity", 1);
            link.style("opacity", 1);
        }

        function reDirect(){
            d=d3.select(this).node()._data_;
            window.location.assign("/tagid/" + d.name.replace("#", "+++"));
        }


    }
</script>
